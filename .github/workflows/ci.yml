name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  go:
    name: Go Build + Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - run: go build ./...
      - run: make go-build

  rust:
    name: Rust Build + Test
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo build --release --manifest-path rust-core/Cargo.toml
      - run: cargo test --manifest-path rust-core/Cargo.toml

  frontend:
    name: Frontend Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: npm
          cache-dependency-path: frontend/package-lock.json
      - run: npm ci
        working-directory: frontend
      - run: npm run build
        working-directory: frontend

  # ── RA-5: Vulnerability Management ──────────────────────────────
  security-sast:
    name: "RA-5: SAST (semgrep)"
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: returntocorp/semgrep-action@v1
        env:
          SEMGREP_RULES: p/default p/security-audit p/owasp-top-ten

  security-govulncheck:
    name: "RA-5: Go Vulns (govulncheck)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - run: go install golang.org/x/vuln/cmd/govulncheck@latest
      - run: govulncheck ./...

  security-sca:
    name: "RA-5: SCA (osv-scanner)"
    runs-on: ubuntu-latest
    continue-on-error: true
    steps:
      - uses: actions/checkout@v4
      - uses: google/osv-scanner-action/osv-scanner-action@v1
        with:
          scan-args: |-
            --recursive
            .

  security-rust:
    name: "RA-5: Rust Audit (cargo-audit)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - run: cargo install cargo-audit
      - run: cargo audit --file rust-core/Cargo.lock

  security-secrets:
    name: "RA-5: Secret Scan (gitleaks)"
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # ── Integration smoke test ──────────────────────────────────────
  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: [go, rust]
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-go@v5
        with:
          go-version: stable
      - run: make go-build
      - name: Health check
        run: |
          ./bin/api &
          sleep 3
          curl -sf --max-time 5 http://localhost:8000/api/health | grep -q '"status":"ok"'
          echo "Health check passed"
